<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lấy câu hỏi</title>
    <style>
        /* Các style của bạn ở đây */
    </style>
</head>
<body>
    <div class="container">
        <h1>Lấy câu hỏi</h1>

        <div class="instructions">
            <!-- Hướng dẫn sử dụng -->
        </div>

        <button id="videoGuideButton">Xem Hướng Dẫn Video</button>

        <div id="jsonInputs">
            <div class="json-group">
                <textarea class="jsonInput" placeholder="Dán vào đây ní ơi..."></textarea>
                <button class="deleteButton">&times;</button>
            </div>
        </div>

        <button id="addJsonButton">Thêm khung nhập dữ liệu lần test nữa</button>
        <button id="processButton">Xử lý</button>
    </div>

    <footer>
        Không share cho ai nhé
    </footer>

    <script>
        document.getElementById('addJsonButton').addEventListener('click', function () {
            const jsonInputs = document.getElementById('jsonInputs');
            const newJsonGroup = document.createElement('div');
            newJsonGroup.className = 'json-group';
            newJsonGroup.innerHTML = `
                <textarea class="jsonInput" placeholder="Dán vào đây ní ơi..."></textarea>
                <button class="deleteButton">&times;</button>
            `;
            jsonInputs.appendChild(newJsonGroup);

            const deleteButton = newJsonGroup.querySelector('.deleteButton');
            deleteButton.addEventListener('click', function () {
                jsonInputs.removeChild(newJsonGroup);
            });
        });

        document.getElementById('processButton').addEventListener('click', async function () {
            const jsonInputs = document.querySelectorAll('.jsonInput');
            const uniqueQuestions = new Map();

            jsonInputs.forEach(input => {
                const jsonInput = input.value;

                if (!jsonInput.trim()) return;

                try {
                    const data = JSON.parse(jsonInput);

                    if (!data || !data.data || !Array.isArray(data.data)) {
                        throw new Error('Dữ liệu JSON không hợp lệ hoặc thiếu thuộc tính "data".');
                    }

                    data.data.forEach(record => {
                        if (!record.test || !Array.isArray(record.test)) {
                            console.warn('Bỏ qua một "record" không có thuộc tính "test" hoặc không phải là mảng.');
                            return;
                        }

                        record.test.forEach(test => {
                            if (!test.id || !test.question_direction || !test.answer_option) {
                                console.warn('Bỏ qua một "test" không đầy đủ thông tin.');
                                return;
                            }

                            const questionId = test.id;

                            if (!uniqueQuestions.has(questionId)) {
                                uniqueQuestions.set(questionId, {
                                    id: questionId,  // Giữ nguyên ID câu hỏi
                                    questionHtml: test.question_direction,
                                    answerOptions: test.answer_option
                                });
                            }
                        });
                    });
                } catch (error) {
                    alert('Một trong các dữ liệu JSON không hợp lệ. Vui lòng kiểm tra lại.');
                    console.error('Lỗi khi phân tích JSON:', error);
                    throw error;
                }
            });

            const processedData = Array.from(uniqueQuestions.values());

            try {
                const response = await fetch('/.netlify/functions/upload', {
                    method: 'POST',
                    body: JSON.stringify({ questions: processedData }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Dữ liệu đã được xử lý thành công và gửi về Telegram.');

                    // Mở nội dung HTML trong tab mới
                    const htmlContent = result.htmlContent; // Nhận nội dung HTML từ backend
                    const newWindow = window.open();
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();  // Đảm bảo nội dung được render
                } else {
                    alert('Đã xảy ra lỗi khi gửi dữ liệu: ' + result.message);
                }

            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error);
                alert('Đã xảy ra lỗi không mong muốn khi gửi dữ liệu.');
            }
        });

        document.getElementById('videoGuideButton').addEventListener('click', function () {
            window.open('https://drive.google.com/file/d/1DgBA0R6jlCU7KjSdF6mei_LKs5bzHf9D/view?usp=sharing', '_blank');
        });
    </script>
</body>
</html>
